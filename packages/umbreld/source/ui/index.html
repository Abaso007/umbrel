<h1>Umbrel</h1>

<form>
	<label for="username">Username:</label>
	<input type="text" name="username" />
	<br />
	<label for="password">Password:</label>
	<input type="password" name="password" />
	<br />
	<input class="register" type="button" value="Register" />
	<input class="submit" type="submit" value="Login" />
</form>
<input class="renew-session" type="button" value="Renew Session" />
<input class="logout" type="button" value="Logout" />

<h2>Log</h2>

<pre class="log"></pre>

<script>
	const formElement = document.querySelector('form')
	const logElement = document.querySelector('.log')
	const registerButton = document.querySelector('.register')
	const renewButton = document.querySelector('.renew-session')
	const logoutButton = document.querySelector('.logout')

	const log = (text) => {
		const textNode = document.createTextNode(`${text}\n`)
		logElement.appendChild(textNode)
	}

	const api = async (endpoint, data) => {
		log(`=> ${endpoint} ${JSON.stringify(data)}`)

		const response = await fetch(`/api${endpoint}`, {
			method: data ? 'POST' : 'GET',
			headers: {'Content-Type': 'application/json'},
			body: data && JSON.stringify(data),
		})

		const responseData = await response.json()
		log(`<= ${response.status} ${JSON.stringify(responseData)}`)
	}

	const getFormData = (value) => {
		const formData = new FormData(formElement)
		return formData.get(value)
	}

	const handler = (element, event, callback) => {
		element.addEventListener(event, (e) => {
			e.preventDefault()
			callback()
		})
	}

	handler(registerButton, 'click', () =>
		api('/register', {username: getFormData('username'), password: getFormData('password')}),
	)
	handler(formElement, 'submit', () => api('/login', {password: getFormData('password')}))
	handler(renewButton, 'click', () => api('/renew-session', {}))
	handler(logoutButton, 'click', () => api('/logout', {}))
</script>
